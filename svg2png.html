<script>

// Copyright © 2025 Michael Thornburgh
// SPDX-License-Identifier: MIT

const img = new Image();
img.crossOrigin = "anonymous";
img.addEventListener("load", () => onImageLoaded());
img.addEventListener("error", () => onImageLoaded());

var blobUrl;

function onDrop(event) {
	event.preventDefault();
	event.stopPropagation();

	const files = event.dataTransfer.files;
	if(files.length)
	{
		const reader = new FileReader();
		reader.onload = (e) => { svgxml.value = e.target.result; onText(); };
		reader.readAsText(files[0]);
	}
	else
	{
		svgxml.value = event.dataTransfer.getData("text/uri-list") || event.dataTransfer.getData("text/plain");
		onText();
	}
}

function onText() {
	if((/^[a-zA-Z0-9]+:/).test(svgxml.value)) // probably a URL
		img.src = svgxml.value;
	else
	{
		blobUrl = URL.createObjectURL(new Blob([svgxml.value], {type: "image/svg+xml"}));
		img.src = blobUrl;
	}

	download.removeAttribute("href");
}

function onImageLoaded() {
	canvas.width = img.naturalWidth * Number(oversample.value);
	canvas.height = img.naturalHeight * Number(oversample.value);
	const ctx = canvas.getContext("2d");
	ctx.clearRect(0, 0, canvas.width, canvas.height);

	try { ctx.drawImage(img, 0, 0, canvas.width, canvas.height); }
	catch(e) { console.log("drawImage", e); }

	dimensions.innerText = `${canvas.width} × ${canvas.height}`;

	if(blobUrl)
	{
		URL.revokeObjectURL(blobUrl);
		blobUrl = null;
	}

	if(img.naturalWidth && img.naturalHeight)
	{
		try { download.href = canvas.toDataURL(); }
		catch(e) { console.log("canvas.toDataURL()", e); }
	}
}

</script>

<style>

* { box-sizing: border-box; }

html, body {
	height: 100%;
	margin: 0;
	block-size: 100%;
	font-family: Avenir Next, Arial, Helvetica, sans-serif, system-ui;
}

.hide-no-link:not(:link) { visibility: hidden; }

</style>

<title>SVG to PNG Converter</title>

<body onload="onText()">

<div style="display: flex; height: 100vh; width: 100vw">
	<div style="padding: 1rem calc(0.5rem + 2px) 1rem 1rem; overflow: auto; width: 25vw; min-width: 25vw; max-width: 90vw; resize: horizontal; display: flex; flex-direction: column; height: 100%; contain: layout; border-right: 0.5px solid;">
		<div>
			<h2>SVG to PNG Converter</h2>
			<p>All processing is local; please “view source” to see.</p>
		</div>

		<textarea id="svgxml"
			style="width: 100%; flex: 1; min-height: 2rem; font-family: monospace; font-size: smaller; resize: none;"
			placeholder="Drop or Paste SVG"
			title="Drop or paste SVG XML or an image URL in this box."
			autocorrect="false"
			spellcheck="false"
			draggable="true"
			ondrop="onDrop(event)"
			oninput="onText()"></textarea>
	
		<div style="padding-top: 0.25rem;">
			<label for="oversample" title>Oversample:</label>
			<select oninput="onImageLoaded()" id="oversample" title="Scale the natural dimensions of the image by this much when rasterizing.">
				<option>0.125</option>
				<option>0.25</option>
				<option>0.5</option>
				<option>1</option>
				<option>2</option>
				<option selected>4</option>
				<option>8</option>
				<option>16</option>
				<option>32</option>
				<option>64</option>
			</select>
			|
			<span id="dimensions" title="The size of the rasterized image in pixels after oversampling/scaling."></span>
			|
			<a download id="download" class="hide-no-link" title="Save the rasterized image as a PNG.">Save PNG</a>

			<footer style="margin-top: 1rem;">
				<a href="https://github.com/zenomt/svg2png">This project is on GitHub</a>
			</footer>
		</div>

		<span title="This panel is resizable." style="position: absolute; inset-block-end: 1rem; inset-inline-end: 0; font-size: x-large;">⇄</span>
	</div>

	<div style="flex: 1; padding: 1rem 1rem 1rem 0.5rem; overflow: auto;">
		<div style="display: flex; justify-content: center; align-items: center; width: 100%; height: 100%;">
			<canvas id="canvas" style="width: 100%; height: 100%; object-fit: contain;" title="The rasterized image."></canvas>
		</div>
	</div>
</div>

</body>
